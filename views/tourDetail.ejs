<link rel="stylesheet" href="/public/css/profile.css">
<link rel="stylesheet" href="/public/css/tour.css">
<%- include ("includes/header") %>
<div class="container hidden-xs container-custom">
    <div class="col-md-12 form-group" style="padding-top: 10px;">
        <span class="title">Trang chủ/ Quản lý lịch trình</span>
    </div>
    <div class="row">
        <div class="col-md-10">
            <a href="" class="nav-link pr-0 leading-none">
                <span class="avatar" style="background-image: url(/public/img/dalat.jpeg)"></span>
                <span class="col-md-8">
                    <span name="user-name" class="user-name text-default">
                        Nguyễn Hoàng Tuấn
                    </span>
                    <div class="row">
                        <small class="text-muted col-md-6 col-lg-4 d-block mt-1">0 đang theo dõi</small>
                        <small class="text-muted col-md-6 col-lg-4 d-block mt-1">0 người theo dõi</small>
                    </div>
                </span>
            </a>
        </div>
        <div class="col-md-2">
            <a style="text-decoration: none;" onclick="prepareToCreateTour();">
                <button class="button button-custom">
                    Tạo tour
                </button>
            </a>
        </div>
    </div>
    <div class="col-md-12">
        <ul class="col-md-12 nav" id="myTab" role="tablist" style="justify-content: center;">
            <li class="nav-item" role="presentation">
                <a class="nav-link active" id="home-tab" data-toggle="tab" href="#team" role="tab" aria-controls="home" aria-selected="true">Thông tin</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#tour" role="tab" aria-controls="profile" aria-selected="false">Lịch trình</a>
            </li>
            <li class="nav-item" role="presentation">
                <a class="nav-link" id="profile-tab" data-toggle="tab" href="#note" role="tab" aria-controls="profile" aria-selected="false">Ghi chú</a>
            </li>
        </ul>
    </div>
    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade show active" id="team" role="tabpanel" aria-labelledby="home-tab">
            <div class="container hidden-xs container-custom">
                <div class="row" id="teamInfo">
                    <div class="form-group col-md-12">
                        <label for="">Tên chuyến đi: </label>
                        <span> <%= tour.tenChuyenDi %></span>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="">Nhóm trưởng: </label>
                        <span> <%= tour.user.name %></span>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="">Địa điểm: </label>
                        <span> từ <%= tour.diemBatDau %> đến <%= tour.diemKetThuc %></span>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="">Thời gian: </label>
                        <span> từ <%= tour.thoiGianBatDau %> đến <%= tour.thoiGianKetThuc %></span>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="">Phương tiện di chuyển: </label>
                        <span> <%= tour.phuongTien %></span>
                    </div>
                    <div class="form-group col-md-12">
                        <label for="">Thành viên: </label>
                        <div id="total-member">
                            
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="tour" role="tabpanel" aria-labelledby="profile-tab">
            <div class="container-custom">
                <div class="col-md-12">
                    <div class="container">
                        <div id="img-total" class="row padxx">
                            <a style="text-decoration: none;" onclick="prepareToCreateTourDetail();">
                                <button class="button button-custom">
                                    Tạo lịch trình
                                </button>
                            </a>
                        </div>
                        <div id="lichtrinh-total" class="row">

                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="note" role="tabpanel" aria-labelledby="profile-tab">
            <div class="container-custom">
                <div class="col-md-12">
                    <div class="container">
                        <div id="img-total" class="row padxx">
                            <a style="text-decoration: none;" onclick="prepareToCreateNote();">
                                <button class="button button-custom">
                                    Tạo ghi chú
                                </button>
                            </a>
                        </div>
                        <div id="ghichu-total" class="row">

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" id="tour-data" value="<%= JSON.stringify(tour); %>">
</div>
<%- include ("includes/footer") %>
<script>
    var isshowtour = true;
    function doKick(self){
        alert("Sẽ phát triển sau")
    }
    function doAcceptTour(self){
        var _id = self.getAttribute("data-id");
        var tourId = self.getAttribute("tourId");
        var ajax = new XMLHttpRequest();
        ajax.open("POST","/acceptRequestJoinTour", true);
        ajax.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var response = JSON.parse(this.responseText);
                if(response.status =="success"){
                    Swal.fire({
                        title: 'Congratulations!',
                        text: 'Chấp nhận thành viên thành công',
                        icon: 'success',
                        timer: 1500
                    })
                }
                else{
                    Swal.fire({
                        title: 'Error!',
                        text: response.message,
                        icon: 'error',
                        timer: 1500
                    })
                    setTimeout(function() {
                        location.reload();
                    }, 1500); 
                }
                self.remove();
            }
        };
        var formData = new FormData();
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("_id",_id);
        formData.append("tourId",tourId);
        ajax.send(formData);
    }
    function doRejectTour(self){
        var _id = self.getAttribute("data-id");
        var tourId = self.getAttribute("tourId");
        var ajax = new XMLHttpRequest();
        ajax.open("POST","/rejectRequestJoinTour",true);
        ajax.onreadystatechange = function() {
            if (this.readyState ==4 && this.status ==200){
                var response = JSON.parse(this.responseText);
                if(response.status =="success"){
                    Swal.fire({
                        title: 'Congratulations!',
                        text: 'Từ chối thành viên thành công',
                        icon: 'success',
                        timer: 1500
                    })
                }
                else{
                    Swal.fire({
                        title: 'Error!',
                        text: response.message,
                        icon: 'error',
                        timer: 1500
                    })
                    setTimeout(function() {
                        location.reload();
                    }, 1500); 
                }
                self.remove();
            }
        };
        var formData = new FormData();
        formData.append("accessToken",localStorage.getItem("accessToken"));
        formData.append("_id",_id);
        formData.append("tourId",tourId);
        ajax.send(formData);
    }
    function doKick(self){
        var _id = self.getAttribute("data-id");
        var tourId = self.getAttribute("tourId");
        var ajax = new XMLHttpRequest();
        ajax.open("POST","/rejectRequestJoinTour",true);
        ajax.onreadystatechange = function() {
            if (this.readyState ==4 && this.status ==200){
                var response = JSON.parse(this.responseText);
                if(response.status =="success"){
                    Swal.fire({
                        title: 'Congratulations!',
                        text: 'Kick thành viên thành công',
                        icon: 'success',
                        timer: 1500
                    })
                    setTimeout(function() {
                        location.reload();
                    }, 1500); 
                }
                else{
                    Swal.fire({
                        title: 'Error!',
                        text: response.message,
                        icon: 'error',
                        timer: 1500
                    })
                    setTimeout(function() {
                        location.reload();
                    }, 1500); 
                }
                self.remove();
            }
        };
        var formData = new FormData();
        formData.append("accessToken",localStorage.getItem("accessToken"));
        formData.append("_id",_id);
        formData.append("tourId",tourId);
        ajax.send(formData);
    }
    function showTourDetail(){
        var tour = document.getElementById("tour-data").value;
        tour = JSON.parse(tour);
        console.log(tour);
        var html= "";
        var text = "";
        var follow = "";
        for (var a = 1; a < tour.members.length; a++) {
            var data = tour.members[a];
            if(data.status == "Pending"){
                html+='<div class="row">'
                    html+= '<span class="col-md-4 padxxx">' + data.name +'</span>';
                    html += '<a style="margin-right: 20px;text-decoration: none;" class="col-lg-2 friend" href="javascript:void(0);" data-id="' + data._id + '" tourId="' + tour._id + '" onclick="doAcceptTour(this);" title="Accept">Accept</a>';
                    html += '<a style="margin-right: 20px;text-decoration: none;" class="col-lg-2 friend" href="javascript:void(0);" data-id="' + data._id + '" tourId="' + tour._id + '" onclick="doRejectTour(this);" title="Reject">Reject</a>';
                    
                html+='</div>'
            }
            else{
                html+='<div class="row">'
                    html+= '<span class="col-md-4 padxxx">' + data.name +'</span>';
                    html += '<a style="margin-right: 20px;text-decoration: none;" class="col-lg-2 friend" href="javascript:void(0);" data-id="' + data._id + '" tourId="' + tour._id + '" onclick="doKick(this);" title="Kick">Kick</a>';
                html+='</div>'
            }
        }
        if(tour.lichTrinh){
            for (var a = 0; a < tour.lichTrinh.length; a++) {
                var data = tour.lichTrinh[a];
                text+= '<div class="col-md-6 pad">';
                    text+= '<label>' + data.tieude + ' </label>';
                    text+='<br>'
                    text+= '<span>' + data.noidung + ' </span>';
                text+= '</div>';
            
            }
        }
        else{
            text+='<span>Chưa có lịch trình cụ thể! Hãy tạo thêm lịch trình bạn nhé!</span>'
        }
        if(tour.ghiChu){
            follow+=' <div class="form-group col-md-12">'
                follow+='<label for="">Ghi chú: </label>'
                follow+='<br>'
                follow+='<span>' + tour.ghiChu + '</span>'
            follow+='</div>'
        }
        else{
            follow+='<span>Chưa có ghi chú. Hãy tạo ghi chú bạn nhé!</span>'
        }
        document.getElementById('ghichu-total').innerHTML = follow;
        document.getElementById('total-member').innerHTML = html;
        document.getElementById('lichtrinh-total').innerHTML = text;
    }
    var currentTab = 0; // Current tab is set to be the first tab (0)
    function nextPrev(n) {
        // This function will figure out which tab to display
        var x = document.getElementsByClassName("tab");
        // Exit the function if any field in the current tab is invalid:
        if (n == 1 && !validateForm()) return false;
        // Hide the current tab:
        x[currentTab].style.display = "none";
        // Increase or decrease the current tab by 1:
        currentTab = currentTab + n;
        // if you have reached the end of the form...
        if (currentTab >= x.length) {
            document.getElementById("regForm").submit();
            var form = document.getElementById("regForm").elements;
            doTour(form);
            return false;
        }
        // Otherwise, display the correct tab:
        showTab(currentTab);
    }
    function doTour(form){
        var ajax = new XMLHttpRequest();
        ajax.open("POST","/createTour", true);

        ajax.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var response = JSON.parse(this.responseText);
                console.log(response);
                if(response.status =="success"){
                    Swal.fire({
                        title: 'Congratulations!',
                        text: 'Bạn đã tạo chuyến đi thành công',
                        icon: 'success',
                        timer: 2500
                    })
                    window.location.href="/home"
                }
            }
        };
        var formData = new FormData($('#regForm')[0]);
        formData.append("accessToken", localStorage.getItem("accessToken"));
        ajax.send(formData);
    }
    function validateForm() {
        // This function deals with validation of the form fields
        var x, y, i, valid = true;
        x = document.getElementsByClassName("tab");
        y = x[currentTab].getElementsByTagName("input");
        // A loop that checks every input field in the current tab:
        for (i = 0; i < y.length; i++) {
            // If a field is empty...
            if (y[i].value == "") {
            // add an "invalid" class to the field:
            y[i].className += " invalid";
            // and set the current valid status to false
            valid = false;
            }
        }
        // If the valid status is true, mark the step as finished and valid:
        if (valid) {
            document.getElementsByClassName("step")[currentTab].className += " finish";
        }
        return valid; // return the valid status
    }
    function fixStepIndicator(n) {
        // This function removes the "active" class of all steps...
        var i, x = document.getElementsByClassName("step");
        for (i = 0; i < x.length; i++) {
            x[i].className = x[i].className.replace(" active", "");
        }
        //... and adds the "active" class on the current step:
        x[n].className += " active";
    }

    function doNote(form){
        var _id = document.getElementById('_id').value;
        var ajax = new XMLHttpRequest();
        ajax.open("POST","/note", true);

        ajax.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var response = JSON.parse(this.responseText);
                console.log(response);
                if(response.status =="success"){
                    Swal.fire({
                        title: 'Congratulations!',
                        text: 'Bạn đã tạo ghi chú thành công',
                        icon: 'success',
                        timer: 2500
                    })
                    window.location.href="/home"
                }
            }
        };
        var formData = new FormData(form);
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("_id",_id);
        ajax.send(formData);
    }

    function doTourDetail(form){
        var _id = document.getElementById('_id').value;
        var ajax = new XMLHttpRequest();
        ajax.open("POST","/lichTrinh", true);
        ajax.onreadystatechange = function(){
            if (this.readyState == 4 && this.status == 200){
                var response = JSON.parse(this.responseText);
                console.log(response);
                if(response.status =="success"){
                    Swal.fire({
                        title: 'Congratulations!',
                        text: 'Bạn đã tạo lịch trình thành công',
                        icon: 'success',
                        timer: 1500
                    })
                    setTimeout(function() {
                        location.reload();
                    }, 1500); 
                }
            }
        };
        var formData = new FormData(form);
        formData.append("accessToken", localStorage.getItem("accessToken"));
        formData.append("_id",_id);
        ajax.send(formData);
    }
</script>
<div class="modal fade" id="createTour" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Tạo mới chuyến phượt</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="regForm">
                    <div class="tab form-group">
                        <div class="form-group">
                            <label for="">Tên chuyến đi?</label>
                            <br>
                            <input type="text" name="tenChuyenDi" class="input-field" placeholder="Tên chuyến đi">
                        </div>
                        <div class="form-group">
                            <label for="">Phượt đi đâu đấy?</label>
                            <br>
                            <input type="text" name="diemBatDau" class="input-field pad" placeholder="Địa điểm bắt đầu">
                            <input type="text" name="diemKetThuc" class="input-field" placeholder="Địa điểm kết thúc">
                        </div>
                    </div>
                    <div class="tab form-group">
                        <div class="form-group">
                            <label for="">Thời gian?</label>
                            <br>
                            <input type="date" name="thoiGianBatDau" class="input-field pad" placeholder="Thời gian bắt đầu">
                            <input type="date" name="thoiGianKetThuc" class="input-field" placeholder="Thời gian kết thúc">
                        </div>
                        <div class="form-group">
                            <label for="">Phương tiện chủ yếu?</label>
                            <br>
                            <select name="phuongTien" class="form-control" name="" id="">
                                <option value="Xe máy">Xe máy</option>
                                <option value="Ô tô">Ô tô</option>
                                <option value="Xe khách">Xe khách</option>
                                <option value="Máy bay">Máy bay</option>
                            </select>
                        </div>
                    </div>
                    <div class="tab form-group">
                        <div class="form-group">
                            <label for="">Số lượng thành viên dự tính?</label>
                            <br>
                            <input name="soLuongThanhVien" type="text" class="input-field" placeholder="Số lượng thành viên dự tính">
                        </div>
                        <div class="form-group">
                            <label for="">Chi phí dự tính?</label>
                            <br>
                            <input name="chiPhi" type="text" class="input-field pad" placeholder="chi phí / 1 người">
                        </div>
                    </div>
                    <div style="overflow:auto;">
                        <div style="float:right;">
                            <button type="button" class="button button-custom" id="prevBtn" onclick="nextPrev(-1)">Quay lại</button>
                            <button type="button" class="button button-custom" id="nextBtn" onclick="nextPrev(1)">Tiếp theo</button>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:40px;">
                        <span class="step"></span>
                        <span class="step"></span>
                        <span class="step"></span>
                    </div>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="createNote" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Ghi chú cho chuyến phượt</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="createNoteTour" onsubmit="return doNote(this)">
                    <div class="form-group">
                        <div class="form-group">
                            <label for="">Ghi chú</label>
                            <br>
                            <input id="_id" value="<%= tour._id %>" type="hidden">
                            <textarea class="form-control" name="ghiChu" id="ghiChu" cols="30" rows="10" placeholder="Ghi chú (Ví dụ: Tập trung vào lúc 6h sáng tại ký túc xá khu B)"></textarea>
                        </div>
                    </div>
                    <div style="overflow:auto;">
                        <div style="float:right;">
                            <button type="submit" class="button button-custom">Hoàn thành</button>
                        </div>
                    </div>
				</form>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" id="createTourDetail" tabindex="-1" role="dialog" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Tạo lịch trình ( khuyến nghị theo ngày )</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<form id="createNoteTour" onsubmit="return doTourDetail(this)">
                    <div class="form-group">
                        <div class="form-group">
                            <label for="">Tiêu đề</label>
                            <br>
                            <input id="_id" value="<%= tour._id %>" type="hidden">
                            <input type="text" class="form-control" name="tieude" placeholder="Tiêu đề (Ví dụ: Ngày 1)">
                        </div>
                        <div class="form-group">
                            <label for="">Nội dung</label>
                            <br>
                            <textarea class="form-control" name="noidung" cols="30" rows="10" placeholder="Nội dung (Ví dụ: Sài Gòn - Cần Thơ)"></textarea>
                        </div>
                    </div>
                    <div style="overflow:auto;">
                        <div style="float:right;">
                            <button type="submit" class="button button-custom">Hoàn thành</button>
                        </div>
                    </div>
				</form>
			</div>
		</div>
	</div>
</div>